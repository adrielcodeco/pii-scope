{"version":3,"sources":["../src/moduleLoader.ts"],"names":[],"mappings":"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","file":"moduleLoader.js","sourcesContent":["import * as fs from 'fs'\nimport * as path from 'path'\nimport * as vm from 'vm'\nimport { stripBOM, stripShebang } from './helpers'\nimport Context from './context'\nconst NativeModule = require('module')\n\nconst _cache = Object.create(null)\nconst _scriptCache = Object.create(null)\nconst NativeRequire = require\nconst _extensions = Object.create(null)\n\nexport function moduleLoader (request: string, parentModule: any, globals: any) {\n  if (!request) {\n    throw new Error('the request argument is invalid')\n  }\n  const filename = NativeModule._resolveFilename(request, parentModule, false)\n  let msg = `Recursive module load detected!\\r\\n`\n  msg += `The \"${request}\" module located in \"${filename}\" will be loaded`\n  msg += `, but this is not a best practice\\r\\n`\n  msg += `This could be a mistake, check your code and correct.\\r\\n`\n  msg += `Parent module \"${parentModule.filename}\".`\n  if (\n    parentModule._recursive &&\n    filename in parentModule._recursive &&\n    parentModule._recursive[filename] === request\n  ) {\n    console.warn(msg)\n    return {}\n  }\n  if (\n    !path.isAbsolute(request) &&\n    parentModule.noCacheFor &&\n    !parentModule.noCacheFor.includes(filename)\n  ) {\n    const cachedModule = _cache[filename]\n    if (cachedModule) {\n      if (cachedModule.loaded) {\n        updateChildren(parentModule, cachedModule, true)\n        return cachedModule.exports\n      } else {\n        console.warn(msg)\n        if (!parentModule._recursive) {\n          parentModule._recursive = Object.create(null)\n        }\n        parentModule._recursive[filename] = request\n      }\n    }\n  }\n  if (!path.isAbsolute(request) && filename === request) {\n    return NativeRequire(request)\n  }\n  const ParentModule = parentModule.constructor\n  const _module = new ParentModule(filename, parentModule)\n  _module.noCacheFor = parentModule.noCacheFor || []\n  _module.filename = filename\n  _module.paths = NativeModule._nodeModulePaths(path.dirname(filename))\n  _module._recursive = parentModule._recursive || Object.create(null)\n  _module.context = parentModule.context\n  if (parentModule.noCacheFor && !parentModule.noCacheFor.includes(filename)) {\n    _cache[filename] = _module\n  }\n  let extension = path.extname(filename) || '.js'\n  if (!_extensions[extension]) {\n    extension = '.js'\n  }\n  try {\n    _extensions[extension](_module, filename, globals)\n  } finally {\n    // does nothing\n  }\n  _module.loaded = true\n  delete _module._recursive[filename]\n  return _module.exports\n}\n\nexport function compatibilityTsNode (filename: string, code: string): string {\n  if (path.extname(filename) === '.ts') {\n    try {\n      const { register } = require('ts-node')\n      code = register().compile(code, filename)\n    } catch (err) {\n      console.debug(err)\n    }\n  }\n  return code\n}\n\nexport function codePreProcessor (filename: string, code: string): string {\n  code = compatibilityTsNode(filename, code)\n  return code\n}\n\nexport function compile (mod: any, filename: string, globals: any): any {\n  if (!filename) {\n    throw new Error('the filename argument is invalid')\n  }\n  if (!mod) {\n    throw new Error('the mod argument is invalid')\n  }\n  const sandbox = new Context(globals)\n  const context = globals ? vm.createContext(sandbox) : mod.context\n  let func\n  if (filename in _scriptCache) {\n    const script = _scriptCache[filename]\n    func = context ? script.runInContext(context) : script.runInThisContext()\n  } else {\n    let content = fs.readFileSync(filename, 'utf8')\n    content = stripBOM(content)\n    content = stripShebang(content)\n    content = codePreProcessor(filename, content)\n    let wrapper = NativeModule.wrap(content)\n    const script = new vm.Script(wrapper, {\n      filename: filename,\n      lineOffset: 0,\n      displayErrors: true\n    })\n    _scriptCache[filename] = script\n    func = context ? script.runInContext(context) : script.runInThisContext()\n  }\n  mod.context = context\n  const customRequire = makeRequireFunction(mod)\n  const dirname = path.dirname(filename)\n  func.call(context, mod.exports, customRequire, mod, filename, dirname)\n  return mod.exports\n}\n\nReflect.set(compile, '_cache', _scriptCache)\n\n_extensions['.js'] = compile\n_extensions['.ts'] = compile\n\n// Native extension for .json\n_extensions['.json'] = NativeModule._extensions['.json']\n// Native extension for .node\n_extensions['.node'] = NativeModule._extensions['.node']\n\nfunction updateChildren (parent: any, child: any, scan: any) {\n  const children = parent && parent.children\n  if (children && !(scan && children.includes(child))) children.push(child)\n}\n\nexport function makeRequireFunction (mod: any) {\n  if (!mod) {\n    throw new Error('the mod argument is invalid')\n  }\n  const _cache = (mod.context || {})._cache || NativeModule._cache\n\n  function require (request: string) {\n    return moduleLoader(request, mod, undefined)\n  }\n\n  function resolve (request: string, options: any) {\n    // tslint:disable-next-line: strict-type-predicates\n    if (typeof request !== 'string') {\n      // throw new ERR_INVALID_ARG_TYPE(\"request\", \"string\", request);\n      throw new Error('The \"request\" argument must be of type \"string\"')\n    }\n    return NativeModule._resolveFilename(request, mod, false, options)\n  }\n\n  function paths (request: string) {\n    // tslint:disable-next-line: strict-type-predicates\n    if (typeof request !== 'string') {\n      // throw new ERR_INVALID_ARG_TYPE(\"request\", \"string\", request);\n      throw new Error('The \"request\" argument must be of type \"string\"')\n    }\n    return NativeModule._resolveLookupPaths(request, mod, true)\n  }\n\n  const requireAny = require as any\n  requireAny['resolve'] = resolve\n  requireAny['paths'] = paths\n  requireAny['main'] = process.mainModule\n  requireAny['extensions'] = _extensions\n  requireAny['cache'] = _cache\n  return require\n}\n"]}